<VirtualHost *:80>
   ServerAdmin ops@<%= node['domain'] %>
   ServerName <%= node['jenkins']['http_proxy']['host_name'] %>

   ErrorLog <%= node['apache']['log_dir'] %>/jenkins-error.log
   TransferLog <%= node['apache']['log_dir'] %>/jenkins-access.log

<% if node['jenkins']['http_proxy']['ssl']['enabled'] -%>
   RewriteEngine on
   RewriteRule ^/?(.*)$ https://<%= node['jenkins']['http_proxy']['host_name'] %>/$1 [L,R=301]
</VirtualHost>

<VirtualHost *:443>
   ServerAdmin ops@<%= node['domain'] %>
   ServerName <%= node['jenkins']['http_proxy']['host_name'] %>
   DocumentRoot /srv/jenkins/htdocs

   ErrorLog <%= node['apache']['log_dir'] %>/jenkins-error.log
   TransferLog <%= node['apache']['log_dir'] %>/jenkins-access.log

   SSLEngine on
   SSLCertificateFile <%= node['jenkins']['http_proxy']['ssl']['cert_path'] %>
<%   if node['jenkins']['http_proxy']['ssl']['chain_path'] -%>
   SSLCertificateChainFile <%= node['jenkins']['http_proxy']['ssl']['chain_path'] %>
<%   end -%>
   SSLCertificateKeyFile <%= node['jenkins']['http_proxy']['ssl']['key_path'] %>
<% end -%>
   PerlFixupHandler Apache2::Authen::OdinAuth

   # Local reverse proxy authorization override
   # Most unix distribution deny proxy by default
   # (ie /etc/apache2/mods-enabled/proxy.conf in Ubuntu)
   <Proxy http://localhost:<%= node['jenkins']['server']['port'] %>/*>
     Order deny,allow
     Allow from all
   </Proxy>

   ProxyPreserveHost on
   ProxyPass         /  http://localhost:<%= node['jenkins']['server']['port'] %>/
   ProxyPassReverse  /  http://localhost:<%= node['jenkins']['server']['port'] %>/
   ProxyPassReverse  /  http://<%= node['jenkins']['http_proxy']['host_name'] %>/
</VirtualHost>
